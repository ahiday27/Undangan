<div id="mg-wrapper" tabindex="0">
    <style>
        /* --- 1. SETUP TAMPILAN DASAR --- */
        #mg-wrapper {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 20px auto;
            background-color: #87CEEB; /* Warna Langit */
            border: 4px solid #34495e;
            border-radius: 10px;
            overflow: hidden;
            font-family: 'Segoe UI', sans-serif;
            user-select: none;
            outline: none; /* Hilangkan garis biru fokus */
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            aspect-ratio: 16/9; /* Rasio Layar Lebar */
        }
        canvas { display: block; width: 100%; height: 100%; }

        /* --- 2. LAYAR OVERLAY (Menu, Game Over, Soal) --- */
        .mg-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: none; flex-direction: column;
            align-items: center; justify-content: center;
            color: #fff; z-index: 50; text-align: center;
        }
        .mg-screen.active { display: flex; }

        .mg-title { font-size: 28px; color: #f1c40f; margin-bottom: 10px; text-shadow: 2px 2px #d35400; font-weight: 800; }
        .mg-btn {
            background: #27ae60; color: white; border: none; padding: 12px 30px;
            font-size: 16px; border-radius: 50px; cursor: pointer; font-weight: bold;
            box-shadow: 0 4px #1e8449; transition: 0.2s; margin-top: 15px;
        }
        .mg-btn:active { transform: scale(0.95); }

        /* --- 3. HUD (Skor & Nyawa) --- */
        #mg-hud {
            position: absolute; top: 15px; left: 15px;
            background: rgba(0,0,0,0.6); padding: 8px 15px;
            border-radius: 20px; color: white; font-weight: bold; font-size: 14px;
            z-index: 10; display: flex; gap: 15px; pointer-events: none;
        }
        #hud-lif { color: #e74c3c; font-size: 16px; } /* Warna Merah Hati */

        /* --- 4. POPUP SOAL MATEMATIKA --- */
        .mg-box {
            background: #fff; padding: 20px; border-radius: 10px;
            width: 90%; max-width: 320px; border-bottom: 5px solid #bdc3c7;
        }
        .mg-input {
            width: 100%; padding: 10px; font-size: 24px; text-align: center;
            margin: 10px 0; border: 2px solid #3498db; border-radius: 5px; color: #2c3e50; font-weight: bold;
        }
        .mg-numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
        .mg-key {
            padding: 15px; background: #34495e; color: white; font-size: 18px; font-weight:bold;
            border: none; border-radius: 5px; cursor: pointer;
        }
        .mg-key:active { background: #2c3e50; }

        /* --- 5. KONTROL KHUSUS HP (TOUCH) --- */
        #mg-touch {
            position: absolute; bottom: 5px; width: 100%; padding: 0 5px;
            display: flex; justify-content: space-between; z-index: 40;
        }
        .mg-tbtn .mg-tbtn {
            /* RUMUS SAKTI: clamp(Minimal, Ideal, Maksimal) */
            
            /* Lebar: Minimal 55px, Idealnya 18% lebar layar, Maksimal 90px */
            width: clamp(55px, 18vw, 90px);
            
            /* Tinggi: Sama dengan lebar agar bulat */
            height: clamp(55px, 18vw, 90px);
            
            /* Ukuran Panah: Menyesuaikan juga */
            font-size: clamp(24px, 8vw, 40px);

            background: rgba(255,255,255,0.25);
            border: 2px solid rgba(255,255,255,0.8); 
            border-radius: 50%; 
            color: white;
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(4px); 
            user-select: none;
            
            /* Agar tombol tidak terlalu mepet bawah */
            margin-bottom: 10px; 
            
            /* Efek bayangan agar terlihat timbul */
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        .mg-tbtn:active { background: rgba(255,255,255,0.5); transform: scale(0.9); }

        /* --- 6. PETUNJUK KHUSUS PC --- */
        #mg-pc-hint {
            position: absolute; bottom: 10px; width: 100%; text-align: center;
            color: rgba(255,255,255,0.7); font-size: 12px; pointer-events: none;
            display: none; /* Sembunyi default */
            text-shadow: 1px 1px 2px black;
        }

        /* --- 7. LOGIKA OTOMATIS (MEDIA QUERY) --- */
        /* Jika layar mendukung mouse (PC/Laptop), sembunyikan tombol sentuh, munculkan teks PC */
        @media (pointer: fine) {
            #mg-touch { display: none !important; }
            #mg-pc-hint { display: block !important; }
        }
    </style>

    <canvas id="mg-canvas"></canvas>

    <div id="mg-hud">
        <span>LVL: <span id="val-lvl">1</span></span>
        <span>SKOR: <span id="val-scr">0</span></span>
        <span style="color:#f1c40f">WAKTU: <span id="val-tm">30</span></span>
        <span id="hud-lif"></span> </div>

    <div id="scr-start" class="mg-screen active">
        <h2 class="mg-title">MATH HERO</h2>
        <p>Jawab Soal & Hindari Duri!</p>
      <p>Alihkan Ke Mode Landscape/Mode Desktop<p>
        <button class="mg-btn" onclick="Game.start()">▶ MULAI MAIN</button>
    </div>

    <div id="scr-math" class="mg-screen">
        <div class="mg-box">
            <h3 id="q-txt" style="color:#333; margin:0">?</h3>
            <p id="q-sub" style="color:#7f8c8d; font-size:12px; margin:5px">...</p>
            <input type="text" id="q-inp" class="mg-input" readonly placeholder="?">
            <div class="mg-numpad">
                <button class="mg-key" onclick="Game.in(1)">1</button><button class="mg-key" onclick="Game.in(2)">2</button><button class="mg-key" onclick="Game.in(3)">3</button>
                <button class="mg-key" onclick="Game.in(4)">4</button><button class="mg-key" onclick="Game.in(5)">5</button><button class="mg-key" onclick="Game.in(6)">6</button>
                <button class="mg-key" onclick="Game.in(7)">7</button><button class="mg-key" onclick="Game.in(8)">8</button><button class="mg-key" onclick="Game.in(9)">9</button>
                <button class="mg-key" onclick="Game.in(0)">0</button><button class="mg-key" onclick="Game.del()" style="background:#c0392b">DEL</button><button class="mg-key" onclick="Game.ok()" style="background:#2980b9">OK</button>
            </div>
        </div>
    </div>

    <div id="scr-end" class="mg-screen">
        <h2 class="mg-title">GAME OVER</h2>
        <p>Skor Akhir: <span id="end-scr" style="font-weight:bold; color:#f1c40f">0</span></p>
        <button class="mg-btn" onclick="Game.start()">COBA LAGI ↺</button>
    </div>

    <div id="mg-touch">
        <div style="display:flex; gap:15px">
            <div id="btn-l" class="mg-tbtn">◄</div>
            <div id="btn-r" class="mg-tbtn">►</div>
        </div>
        <div id="btn-j" class="mg-tbtn" style="background:rgba(241,196,15,0.4); border-color:#f1c40f;">▲</div>
    </div>

    <div id="mg-pc-hint">Gunakan <b>Panah Kiri/Kanan</b> untuk jalan, <b>Spasi/Panah Atas</b> untuk lompat</div>

    <script>
    var Game = (function() {
        // --- AUDIO ENGINE ---
        const Snd = {
            ctx: null, bgm: null,
            init: function() {
                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                if(!this.ctx) this.ctx = new AudioContext();
                if(this.ctx.state === 'suspended') this.ctx.resume();
            },
            play: function(f, t, d, v=0.1) {
                if(!this.ctx) return;
                const o=this.ctx.createOscillator(), g=this.ctx.createGain();
                o.type=t; o.frequency.value=f;
                g.gain.setValueAtTime(v, this.ctx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime+d);
                o.connect(g); g.connect(this.ctx.destination);
                o.start(); o.stop(this.ctx.currentTime+d);
            },
            sfx: {
                jump: ()=> Snd.play(200,'square',0.1),
                coin: ()=> { Snd.play(1000,'square',0.1); setTimeout(()=>Snd.play(1500,'square',0.15),80); },
                hit: ()=> Snd.play(100,'sawtooth',0.3,0.2),
                win: ()=> [400,500,600,800].forEach((f,i)=>setTimeout(()=>Snd.play(f,'square',0.2),i*150))
            },
            music: function(on) {
                if(this.bgm) clearInterval(this.bgm);
                if(on) {
                    let n=[330,330,392,262], i=0;
                    this.bgm = setInterval(()=>{ if(state=='PLAY') { Snd.play(n[i],'triangle',0.2,0.03); i=(i+1)%n.length; } }, 300);
                }
            }
        };

        // --- GAME LOGIC ---
        const cvs = document.getElementById('mg-canvas');
        const ctx = cvs.getContext('2d');
        const wrap = document.getElementById('mg-wrapper');
        let GW=800, GH=450;
        let state='MENU', lvl=1, scr=0, lif=3, time=30, tick=0;
        let p = {x:50, y:300, w:30, h:30, vx:0, vy:0, g:false};
        let keys = {l:false, r:false};
        let math = {ans:0, str:"", rem:0};

        // 5 Level Data
        const lvls = [
            { p:[{x:0,y:400,w:800,h:50},{x:300,y:320,w:200,h:20}], h:[], t:{x:720,y:350,k:'EXIT'}, d:2 },
            { p:[{x:0,y:400,w:200,h:50},{x:250,y:350,w:100,h:20},{x:400,y:300,w:100,h:20},{x:600,y:400,w:200,h:50}], h:[], t:{x:750,y:350,k:'EXIT'}, d:4 },
            { p:[{x:0,y:400,w:150,h:50},{x:200,y:300,w:80,h:20},{x:400,y:300,w:80,h:20},{x:600,y:400,w:200,h:50}], h:[{x:150,y:430,w:450,h:20}], t:{x:750,y:350,k:'EXIT'}, d:6 },
            { p:[{x:0,y:400,w:100,h:50},{x:150,y:300,w:60,h:20},{x:300,y:220,w:60,h:20},{x:450,y:300,w:60,h:20},{x:650,y:400,w:150,h:50}], h:[{x:100,y:430,w:550,h:20}], t:{x:720,y:350,k:'EXIT'}, d:8 },
            { p:[{x:0,y:400,w:800,h:50},{x:100,y:280,w:150,h:20},{x:550,y:280,w:150,h:20}], h:[], t:{x:350,y:200,k:'BOSS'}, d:10 }
        ];

        function resize() { cvs.width=GW; cvs.height=GH; }
        
        function loop() {
    if(state !== 'PLAY') return;
    
    // --- TAMBAHKAN KODE INI ---
    tick++;
    if(tick >= 30) { // Asumsi game berjalan 60 FPS, maka 60 frame = 1 detik
        tick = 0;
        time--;
        updHUD(); // Update tampilan angka
        if(time <= 0) die(); // Jika waktu habis, panggil fungsi mati
    }
    // --------------------------

    ctx.clearRect(0,0,GW,GH);
    // ... (kode sisanya biarkan sama)
            // Move
            if(keys.r) p.vx+=0.8; if(keys.l) p.vx-=0.8;
            p.vx*=0.85; p.vy+=0.8; p.x+=p.vx; p.y+=p.vy;

            // Draw Level
            let l = lvls[lvl-1]; p.g=false;
            ctx.fillStyle = '#27ae60'; // Platform
            l.p.forEach(b => {
                ctx.fillRect(b.x, b.y, b.w, b.h);
                if(p.x<b.x+b.w && p.x+p.w>b.x && p.y<b.y+b.h && p.y+p.h>b.y) {
                    if(p.vy>=0 && p.y+p.h-p.vy<=b.y+20) { p.g=true; p.vy=0; p.y=b.y-p.h; }
                    else if(p.vy<0 && p.y-p.vy>=b.y+b.h) { p.vy=0; p.y=b.y+b.h; }
                }
            });

            // Hazards
            ctx.fillStyle = '#c0392b';
            l.h.forEach(h => {
                ctx.fillRect(h.x, h.y, h.w, h.h);
                if(p.x<h.x+h.w && p.x+p.w>h.x && p.y<h.y+h.h && p.y+p.h>h.y) die();
            });

            // Trigger
            let tr = l.t;
            ctx.fillStyle = tr.k=='EXIT'?'#f1c40f':'#9b59b6';
            ctx.fillRect(tr.x, tr.y, 40, 50);
            ctx.fillStyle = '#fff'; ctx.font='10px Arial'; ctx.fillText(tr.k=='EXIT'?'GO':'BOSS', tr.x+5, tr.y-10);

            if(p.x<tr.x+40 && p.x+p.w>tr.x && p.y<tr.y+50 && p.y+p.h>tr.y) {
                p.vx=0; p.x-=40; startMath(tr.k=='EXIT'?1:5);
            }

            // Player
            ctx.fillStyle = '#2980b9'; ctx.fillRect(p.x, p.y, p.w, p.h);
            ctx.fillStyle = '#fff'; ctx.fillRect(p.vx>=0?p.x+20:p.x+5, p.y+5, 5, 5); // Mata

            if(p.y>GH) die();
            if(p.x<0) p.x=0; if(p.x>GW-p.w) p.x=GW-p.w;

            requestAnimationFrame(loop);
        }

        function die() {
            lif--; Snd.sfx.hit(); updHUD(); p.x=50; p.y=300; p.vx=0; p.vy=0;
            if(lif<=0) {
                state='END'; Snd.music(false);
                document.getElementById('end-scr').innerText = scr;
                document.getElementById('scr-end').classList.add('active');
            }
        }

        function startMath(c) {
            state='MATH'; math.rem=c; genQ();
            document.getElementById('scr-math').classList.add('active');
        }
        function genQ() {
            let d = lvls[lvl-1].d;
            let a=Math.floor(Math.random()*d)+2, b=Math.floor(Math.random()*9)+2;
            math.ans = a*b; math.str = "";
            document.getElementById('q-txt').innerText = `${a} x ${b} = ?`;
            document.getElementById('q-inp').value = "";
            document.getElementById('q-sub').innerText = math.rem>1 ? `BOSS HP: ${math.rem}` : "Jawab untuk lanjut!";
        }
        function updHUD() {
            document.getElementById('val-lvl').innerText = lvl;
            document.getElementById('val-scr').innerText = scr;
            document.getElementById('val-tm').innerText = time;
            // Gunakan Unicode untuk Love agar aman
            document.getElementById('hud-lif').innerText = "\u2764".repeat(lif);
        }

        return {
            start: function() {
                wrap.focus(); Snd.init(); Snd.music(true);
                lvl=1; scr=0; lif=3; time=30; tick=0; p.x=50; p.y=300;
                document.querySelectorAll('.mg-screen').forEach(e=>e.classList.remove('active'));
                state='PLAY'; updHUD(); resize(); loop();
            },
            in: function(n) { if(math.str.length<3){math.str+=n; document.getElementById('q-inp').value=math.str;} },
            del: function() { math.str=math.str.slice(0,-1); document.getElementById('q-inp').value=math.str; },
            ok: function() {
                if(parseInt(math.str) === math.ans) {
                    scr+=10; math.rem--; Snd.sfx.coin();
                    if(math.rem<=0) {
                        document.getElementById('scr-math').classList.remove('active');
                        lvl++; wrap.focus();
                        time = 30;
                        if(lvl>5) {
                            state='END'; Snd.music(false); Snd.sfx.win();
                            document.getElementById('end-scr').innerText = scr;
                            document.querySelector('#scr-end h2').innerText = "MENANG SEMPURNA!";
                            document.getElementById('scr-end').classList.add('active');
                        } else { state='PLAY'; p.x=50; p.y=300; loop(); }
                    } else { scr+=5; genQ(); }
                } else {
                    document.getElementById('scr-math').classList.remove('active');
                    wrap.focus(); die(); if(lif>0){ state='PLAY'; loop(); }
                }
                updHUD();
            },
            bind: function() {
                wrap.addEventListener('click', ()=>wrap.focus());
                window.addEventListener('keydown', e=>{
                    if(state=='PLAY') {
                        if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight',' '].includes(e.key) && document.activeElement===wrap) e.preventDefault();
                        if(e.key=='ArrowRight') keys.r=true;
                        if(e.key=='ArrowLeft') keys.l=true;
                        if(e.key==' '||e.key=='ArrowUp') if(p.g){p.vy=-20;p.g=false;Snd.sfx.jump();}
                    }
                });
                window.addEventListener('keyup', e=>{
                    if(e.key=='ArrowRight') keys.r=false;
                    if(e.key=='ArrowLeft') keys.l=false;
                });
                const tB = (id,k,j)=>{
                    let el=document.getElementById(id);
                    if(el) {
                        el.addEventListener('touchstart', e=>{e.preventDefault(); if(j&&p.g){p.vy=-20;p.g=false;Snd.sfx.jump();}else keys[k]=true;});
                        el.addEventListener('touchend', e=>{e.preventDefault(); if(!j)keys[k]=false;});
                    }
                }
                tB('btn-l','l'); tB('btn-r','r'); tB('btn-j','u',true);
            }
        };
    })();

    setTimeout(Game.bind, 500);
    </script>
</div>
